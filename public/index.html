<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phi·∫øu Xu·∫•t Kho - Tr∆∞·ªùng An</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      /* C·∫•u h√¨nh chung cho trang */
      body {
        font-family: "Times New Roman", Times, serif;
        font-size: 13pt;
        line-height: 1.4;
        margin: 0;
        padding: 20px;
        background: #525659; /* M√†u n·ªÅn x√°m gi·ªëng tr√¨nh xem PDF */
      }

      /* Khung gi·∫•y A4 */
      .page {
        background: white;
        width: 210mm;
        min-height: 297mm;
        padding: 15mm 20mm;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        position: relative;
        box-sizing: border-box;
      }

      /* Header: Logo v√† T√™n c√¥ng ty */
      .header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 20px;
        border-bottom: 2px solid #000;
        padding-bottom: 15px;
      }
      .logo {
        width: 120px;
        flex-shrink: 0;
      }
      .logo img {
        width: 100%;
        height: auto;
      }

      .company-info {
        text-align: center;
        flex-grow: 1;
        padding-right: 0;
      }
      .company-name {
        font-weight: bold;
        font-size: 14pt;
        text-transform: uppercase;
        margin-bottom: 5px;
        color: #b72025; /* M√†u ƒë·ªè th∆∞∆°ng hi·ªáu n·∫øu c·∫ßn */
      }
      .stars {
        margin: 5px 0;
        color: #f1c40f;
        font-size: 16pt;
      }
      .form-title {
        font-size: 20pt;
        font-weight: bold;
        margin-top: 10px;
        text-transform: uppercase;
      }

      /* Ph·∫ßn th√¥ng tin chung (S·ªë phi·∫øu, ng√†y th√°ng...) */
      .info-section {
        margin-bottom: 20px;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .info-left {
        width: 65%;
      }
      .info-right {
        width: 35%;
        text-align: right;
      }
      .info-full {
        width: 100%;
        margin-bottom: 8px;
      }

      .label {
        font-weight: bold;
      }

      /* B·∫£ng d·ªØ li·ªáu */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 12pt;
      }
      th,
      td {
        border: 1px solid black;
        padding: 6px;
        text-align: center;
        vertical-align: middle;
      }
      th {
        background-color: #e6f3ff;
        font-weight: bold;
        height: 40px;
      }

      /* CƒÉn ch·ªânh c·ªôt trong b·∫£ng */
      .col-left {
        text-align: left;
      }
      .col-wrap {
        white-space: pre-wrap;
      } /* ƒê·ªÉ xu·ªëng d√≤ng n·∫øu n·ªôi dung d√†i */

      /* Ph·∫ßn ch·ªØ k√Ω */
      .signature-section {
        display: flex;
        justify-content: space-between;
        margin-top: 40px;
        text-align: center;
        page-break-inside: avoid;
      }
      .sig-box {
        width: 24%;
      }
      .sig-title {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 11pt;
      }
      .sig-note {
        font-style: italic;
        font-size: 10pt;
        margin-bottom: 80px;
      }
      .sig-name {
        font-weight: bold;
        margin-top: 10px;
      }

      /* N√∫t b·∫•m ƒëi·ªÅu khi·ªÉn (S·∫Ω ·∫©n khi in) */
      .controls {
        text-align: center;
        margin-bottom: 20px;
        position: sticky;
        top: 10px;
        z-index: 100;
      }
      .btn {
        padding: 10px 25px;
        font-size: 16px;
        cursor: pointer;
        color: white;
        border: none;
        border-radius: 5px;
        margin: 0 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-weight: bold;
      }
      .btn-print {
        background: #007bff;
      }
      .btn-print:hover {
        background: #0056b3;
      }
      .btn-pdf {
        background: #dc3545;
      }
      .btn-pdf:hover {
        background: #a71d2a;
      }

      /* M√†n h√¨nh loading */
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }

      /* C·∫§U H√åNH KHI IN (QUAN TR·ªåNG) */
      @media print {
        body {
          background: white;
          padding: 0;
          margin: 0;
        }
        .controls,
        #loading {
          display: none !important;
        }
        .page {
          box-shadow: none;
          margin: 0;
          width: 100%;
          max-width: 100%;
          padding: 10mm 15mm;
          border: none;
        }
        @page {
          size: A4;
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <div id="loading-text">ƒêang k·∫øt n·ªëi ƒë·∫øn h·ªá th·ªëng d·ªØ li·ªáu...</div>
    </div>

    <div class="controls">
      <button class="btn btn-print" onclick="window.print()">
        üñ®Ô∏è In Phi·∫øu
      </button>
      <button class="btn btn-pdf" onclick="exportPDF()">üìÑ Xu·∫•t PDF</button>
    </div>

    <div class="page" id="printable-area">
      <div class="header">
        <div class="logo">
          <img
            src="https://via.placeholder.com/150x80?text=LOGO+TRUONG+AN"
            alt="Logo Truong An"
          />
        </div>
        <div class="company-info">
          <div class="company-name">
            C√îNG TY C·ªî PH·∫¶N C∆† ƒêI·ªÜN V√Ä PCCC TR∆Ø·ªúNG AN
          </div>
          <div class="stars">‚≠ê‚≠ê‚≠ê</div>
          <div class="form-title">PHI·∫æU XU·∫§T KHO</div>
        </div>
      </div>

      <div class="info-section">
        <div class="info-row">
          <div class="info-left">
            <span class="label">D·ª± √°n:</span>
            <span id="du-an">NH√Ä M√ÅY GOERTEK (GIAI ƒêO·∫†N 3)</span>
          </div>
          <div class="info-right">
            <span class="label">S·ªë phi·∫øu:</span> <span id="so-phieu">...</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-left">
            <span class="label">Nh√† x∆∞·ªüng:</span>
            <span id="nha-xuong">...</span>
          </div>
          <div class="info-right">
            <span class="label">Ng√†y/th√°ng:</span>
            <span id="ngay-thang">...</span>
          </div>
        </div>
        <div class="info-full">
          <span class="label">T·ªï ƒë·ªôi/Nh√† cung c·∫•p:</span>
          <span id="nha-cung-cap">...</span>
        </div>
        <div class="info-full">
          <span class="label">Di·ªÖn gi·∫£i/N·ªôi dung xu·∫•t:</span>
          <span id="dien-giai">...</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 5%">Stt</th>
            <th style="width: 12%">M√£ v·∫≠t t∆∞</th>
            <th style="width: 30%">T√™n v·∫≠t t∆∞, thi·∫øt b·ªã</th>
            <th style="width: 8%">ƒêVT</th>
            <th style="width: 15%">Quy c√°ch, M√£ hi·ªáu</th>
            <th style="width: 10%">Nh√£n hi·ªáu</th>
            <th style="width: 8%">SL ƒë·ªÅ ngh·ªã</th>
            <th style="width: 8%">Th·ª±c xu·∫•t</th>
            <th style="width: 10%">Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>

      <div class="signature-section">
        <div class="sig-box">
          <div class="sig-title">Ph√™ duy·ªát</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Ng∆∞·ªùi l·∫≠p</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Ng∆∞·ªùi nh·∫≠n</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Th·ªß kho</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
      </div>
    </div>

    <script>
      // C·∫§U H√åNH API
      // V√¨ file HTML n√†y n·∫±m c√πng server v·ªõi Nodejs n√™n ch·ªâ c·∫ßn g·ªçi path t∆∞∆°ng ƒë·ªëi
      const API_URL = "/api/print-data";

      // H√†m format ng√†y th√°ng (YYYY-MM-DD -> DD/MM/YYYY)
      function formatDate(dateString) {
        if (!dateString) return "";
        try {
          // Lark th∆∞·ªùng tr·∫£ v·ªÅ timestamp (s·ªë milliseconds) ho·∫∑c chu·ªói
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return dateString; // N·∫øu kh√¥ng parse ƒë∆∞·ª£c th√¨ tr·∫£ v·ªÅ nguy√™n g·ªëc

          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0"); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        } catch (e) {
          return dateString;
        }
      }

      async function loadData() {
        const params = new URLSearchParams(window.location.search);
        const recordId = params.get("id");

        const loadingEl = document.getElementById("loading");
        const loadingText = document.getElementById("loading-text");

        if (!recordId) {
          loadingText.innerText = "L·ªói: Kh√¥ng t√¨m th·∫•y ID phi·∫øu tr√™n URL!";
          loadingText.style.color = "red";
          return;
        }

        try {
          // G·ªçi API Node.js
          const response = await fetch(`${API_URL}?id=${recordId}`);

          if (!response.ok) {
            throw new Error(`Server Error: ${response.status}`);
          }

          const data = await response.json();

          // --- ƒê·ªï d·ªØ li·ªáu v√†o HTML ---

          // 1. Header
          document.getElementById("so-phieu").innerText = data.soPhieu || "";
          document.getElementById("nha-xuong").innerText = data.nhaXuong || "";
          document.getElementById("ngay-thang").innerText = formatDate(
            data.ngayNhap
          );
          document.getElementById("nha-cung-cap").innerText =
            data.nhaCungCap || "";
          document.getElementById("dien-giai").innerText = data.noiDung || "";

          // 2. Table Detail
          const tbody = document.getElementById("table-body");
          tbody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©/demo

          if (data.items && data.items.length > 0) {
            data.items.forEach((item, index) => {
              const tr = document.createElement("tr");

              // X·ª≠ l√Ω c√°c tr∆∞·ªùng null/undefined
              const maVt = item.maVt || "";
              const tenVt = item.tenVt || "";
              const dvt = item.dvt || "";
              const quyCach = item.quyCach || "";
              const nhanHieu = item.nhanHieu || "";
              const slDeNghi = item.slDeNghi || "";
              const ghiChu = item.ghiChu || "";

              tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${maVt}</td>
                            <td class="col-left col-wrap"><b>${tenVt}</b></td>
                            <td>${dvt}</td>
                            <td class="col-wrap">${quyCach}</td>
                            <td>${nhanHieu}</td>
                            <td style="font-weight:bold;">${slDeNghi}</td>
                            <td></td> <td class="col-wrap">${ghiChu}</td>
                        `;
              tbody.appendChild(tr);
            });
          } else {
            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt
            tbody.innerHTML =
              '<tr><td colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu v·∫≠t t∆∞</td></tr>';
          }

          // T·∫Øt loading
          loadingEl.classList.add("hidden");
        } catch (e) {
          console.error(e);
          loadingText.innerText = "C√≥ l·ªói x·∫£y ra: " + e.message;
          loadingText.style.color = "red";
        }
      }

      // H√†m xu·∫•t PDF
      function exportPDF() {
        const element = document.getElementById("printable-area");

        // L·∫•y s·ªë phi·∫øu ƒë·ªÉ ƒë·∫∑t t√™n file
        const soPhieu =
          document.getElementById("so-phieu").innerText || "Phieu_Xuat";

        const opt = {
          margin: 0,
          filename: `Phieu_Xuat_Kho_${soPhieu}.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true }, // scale 2 ƒë·ªÉ n√©t h∆°n
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        };

        // ·∫®n n√∫t tr∆∞·ªõc khi t·∫°o PDF (ƒë·ªÅ ph√≤ng)
        const controls = document.querySelector(".controls");
        controls.style.display = "none";

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            // Hi·ªán l·∫°i n√∫t sau khi xong
            controls.style.display = "block";
          });
      }

      // Ch·∫°y h√†m khi trang t·∫£i xong
      window.onload = loadData;
    </script>
  </body>
</html>
