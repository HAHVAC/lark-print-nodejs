<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phi·∫øu Xu·∫•t Kho - Tr∆∞·ªùng An</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      /* --- C·∫§U H√åNH CHUNG --- */
      body {
        font-family: "Times New Roman", Times, serif;
        font-size: 13pt;
        margin: 0;
        padding: 20px;
        background-color: #525659; /* M√†u n·ªÅn x√°m ƒë·ªÉ n·ªïi b·∫≠t kh·ªï gi·∫•y */
      }

      /* --- KH·ªî GI·∫§Y A4 --- */
      .page {
        background: white;
        width: 210mm;
        min-height: 297mm;
        padding: 15mm 20mm;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        box-sizing: border-box;
        position: relative;
      }

      /* --- HEADER --- */
      .header {
        display: flex;
        align-items: flex-start;
        margin-bottom: 20px;
      }
      .logo {
        width: 120px;
        margin-right: 20px;
      }
      .logo img {
        width: 100%;
        height: auto;
      }

      .company-info {
        text-align: center;
        flex-grow: 1;
      }
      .company-name {
        font-weight: bold;
        font-size: 14pt;
        text-transform: uppercase;
        margin-bottom: 5px;
      }
      .stars {
        color: #f1c40f;
        margin: 5px 0;
      }
      .form-title {
        font-size: 20pt;
        font-weight: bold;
        margin-top: 15px;
        text-transform: uppercase;
      }

      /* --- TH√îNG TIN PHI·∫æU --- */
      .info-section {
        margin-bottom: 15px;
        line-height: 1.5;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
      }
      .info-left {
        width: 65%;
      }
      .info-right {
        width: 35%;
        text-align: right;
      }
      .label {
        font-weight: bold;
      }

      /* --- B·∫¢NG V·∫¨T T∆Ø --- */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 11pt;
      }
      th,
      td {
        border: 1px solid black;
        padding: 5px;
        text-align: center;
        vertical-align: middle;
      }
      th {
        background-color: #dbeeff;
        font-weight: bold;
        height: 40px;
      }
      .text-left {
        text-align: left;
      }
      .col-wrap {
        white-space: pre-wrap;
      } /* T·ª± xu·ªëng d√≤ng n·∫øu ch·ªØ d√†i */

      /* --- CH·ªÆ K√ù --- */
      .signature-section {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        text-align: center;
        page-break-inside: avoid; /* Tr√°nh b·ªã ng·∫Øt trang gi·ªØa ch·ª´ng */
      }
      .sig-box {
        width: 24%;
      }
      .sig-title {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 11pt;
      }
      .sig-note {
        font-style: italic;
        font-size: 10pt;
        margin-top: 5px;
        margin-bottom: 80px;
      }

      /* --- LOADING SPINNER --- */
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }

      /* --- N√öT B·∫§M --- */
      .controls {
        text-align: center;
        margin-bottom: 20px;
        position: sticky;
        top: 10px;
        z-index: 100;
      }
      .btn {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        color: white;
        border: none;
        border-radius: 4px;
        margin: 0 5px;
      }
      .btn-print {
        background: #007bff;
      }
      .btn-pdf {
        background: #dc3545;
      }

      /* --- CH·∫æ ƒê·ªò IN (Khi b·∫•m Ctrl+P) --- */
      @media print {
        body {
          background: white;
          padding: 0;
          margin: 0;
        }
        .page {
          box-shadow: none;
          margin: 0;
          width: 100%;
          border: none;
          padding: 10mm 10mm;
        }
        .controls,
        #loading {
          display: none !important;
        }
        @page {
          size: A4;
          margin: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p
        id="loading-text"
        style="margin-top: 15px; font-weight: bold; color: #555"
      >
        ƒêang t·∫£i d·ªØ li·ªáu phi·∫øu...
      </p>
    </div>

    <div class="controls">
      <button class="btn btn-print" onclick="window.print()">
        üñ®Ô∏è In Phi·∫øu
      </button>
      <button class="btn btn-pdf" onclick="exportPDF()">üìÑ Xu·∫•t PDF</button>
    </div>

    <div class="page" id="printable-area">
      <div class="header">
        <div class="logo">
          <img src="https://via.placeholder.com/150x80?text=LOGO" alt="Logo" />
        </div>
        <div class="company-info">
          <div class="company-name">
            C√îNG TY C·ªî PH·∫¶N C∆† ƒêI·ªÜN V√Ä PCCC TR∆Ø·ªúNG AN
          </div>
          <div class="stars">‚≠ê‚≠ê‚≠ê</div>
          <div class="form-title">PHI·∫æU XU·∫§T KHO</div>
        </div>
      </div>

      <div class="info-section">
        <div class="info-row">
          <div class="info-left">
            <span class="label">D·ª± √°n:</span>
            <span id="du-an">NH√Ä M√ÅY GOERTEK (GIAI ƒêO·∫†N 3)</span>
          </div>
          <div class="info-right">
            <span class="label">S·ªë phi·∫øu:</span> <span id="so-phieu">...</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-left">
            <span class="label">H·∫°ng m·ª•c:</span> <span id="hang-muc">...</span>
          </div>
          <div class="info-right">
            <span class="label">Ng√†y/th√°ng:</span>
            <span id="ngay-thang">...</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-left">
            <span class="label">Nh√† x∆∞·ªüng:</span>
            <span id="nha-xuong">...</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-left">
            <span class="label">T·ªï ƒë·ªôi/NCC:</span>
            <span id="nha-cung-cap">...</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-left">
            <span class="label">Di·ªÖn gi·∫£i:</span>
            <span id="dien-giai">...</span>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 5%">Stt</th>
            <th style="width: 10%">M√£ VT</th>
            <th style="width: 25%">T√™n v·∫≠t t∆∞, thi·∫øt b·ªã</th>
            <th style="width: 8%">ƒêVT</th>
            <th style="width: 15%">Quy c√°ch,<br />M√£ hi·ªáu</th>
            <th style="width: 10%">Nh√£n hi·ªáu</th>
            <th style="width: 8%">SL ƒë·ªÅ ngh·ªã</th>
            <th style="width: 8%">Th·ª±c xu·∫•t</th>
            <th style="width: 11%">Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>

      <div class="signature-section">
        <div class="sig-box">
          <div class="sig-title">Ph√™ duy·ªát</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Ng∆∞·ªùi l·∫≠p</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Ng∆∞·ªùi nh·∫≠n</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
        <div class="sig-box">
          <div class="sig-title">Th·ªß kho</div>
          <div class="sig-note">(K√Ω, ghi r√µ h·ªç t√™n)</div>
        </div>
      </div>
    </div>

    <script>
      // ƒê∆∞·ªùng d·∫´n API (C√πng server n√™n d√πng relative path)
      const API_URL = "/api/print-data";

      // H√†m format ng√†y th√°ng
      function formatDate(dateStr) {
        if (!dateStr) return "";
        try {
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr;
          return `${d.getDate().toString().padStart(2, "0")}/${(
            d.getMonth() + 1
          )
            .toString()
            .padStart(2, "0")}/${d.getFullYear()}`;
        } catch (e) {
          return dateStr;
        }
      }

      // H√†m ch√≠nh: L·∫•y d·ªØ li·ªáu v√† hi·ªÉn th·ªã
      async function loadData() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        const loadingText = document.getElementById("loading-text");

        if (!id) {
          loadingText.innerText = "L·ªói: Kh√¥ng t√¨m th·∫•y ID phi·∫øu tr√™n URL!";
          loadingText.style.color = "red";
          return;
        }

        try {
          const res = await fetch(`${API_URL}?id=${id}`);
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server");

          const data = await res.json();

          // 1. ƒêi·ªÅn th√¥ng tin chung (Header)
          document.getElementById("so-phieu").innerText = data.soPhieu || "";
          document.getElementById("nha-xuong").innerText = data.nhaXuong || "";
          document.getElementById("ngay-thang").innerText = formatDate(
            data.ngayNhap
          );
          document.getElementById("nha-cung-cap").innerText =
            data.nhaCungCap || "";
          document.getElementById("dien-giai").innerText = data.noiDung || "";
          // N·∫øu c√≥ th√™m field 'H·∫°ng m·ª•c' trong backend, th√™m v√†o ƒë√¢y, t·∫°m th·ªùi ƒë·ªÉ tr·ªëng ho·∫∑c l·∫•y t·ª´ nhaXuong
          // document.getElementById('hang-muc').innerText = data.hangMuc || "";

          // 2. ƒêi·ªÅn b·∫£ng (Table)
          const tbody = document.getElementById("table-body");
          tbody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

          if (data.items && data.items.length > 0) {
            data.items.forEach((item, index) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.maVt || ""}</td>
                            <td class="text-left col-wrap"><b>${
                              item.tenVt || ""
                            }</b></td>
                            <td>${item.dvt || ""}</td>
                            <td class="col-wrap">${item.quyCach || ""}</td>
                            <td>${item.nhanHieu || ""}</td>
                            <td style="font-weight:bold">${
                              item.slDeNghi || ""
                            }</td>
                            <td></td> <td class="text-left col-wrap">${
                              item.ghiChu || ""
                            }</td>
                        `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = `<tr><td colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu v·∫≠t t∆∞</td></tr>`;
          }

          // T·∫Øt loading
          document.getElementById("loading").classList.add("hidden");
        } catch (error) {
          console.error(error);
          loadingText.innerText = "C√≥ l·ªói x·∫£y ra: " + error.message;
          loadingText.style.color = "red";
        }
      }

      // H√†m xu·∫•t PDF
      function exportPDF() {
        const element = document.getElementById("printable-area");
        const soPhieu =
          document.getElementById("so-phieu").innerText || "Phieu";

        // ·∫®n n√∫t tr∆∞·ªõc khi ch·ª•p
        document.querySelector(".controls").style.display = "none";

        const opt = {
          margin: 0,
          filename: `Phieu_Xuat_${soPhieu}.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            // Hi·ªán l·∫°i n√∫t sau khi xong
            document.querySelector(".controls").style.display = "block";
          });
      }

      // Ch·∫°y khi t·∫£i trang
      window.onload = loadData;
    </script>
  </body>
</html>
